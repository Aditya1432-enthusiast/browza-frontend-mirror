name: Mirror main to personal repo

on:
  push:
    branches: [ "main" ]   # runs only after merges to main

permissions:
  contents: read

jobs:
  mirror:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Mirror to personal (verify then push)
        env:
          MIRROR_URL_RAW: ${{ secrets.MIRROR_URL }}
        run: |
          set -euo pipefail
          if [ -z "${MIRROR_URL_RAW:-}" ]; then
            echo "MIRROR_URL is not set; skipping mirror."
            exit 0
          fi
          # Strip any hidden CR/LF/whitespace
          MIRROR_URL=$(printf '%s' "$MIRROR_URL_RAW" | tr -d '\r\n' | sed -e 's/[[:space:]]//g')

          # Show where we're pushing (token masked)
          SAFE_URL=$(echo "$MIRROR_URL" | sed -E 's#https://[^@]+@#https://#')
          echo "Will mirror to: $SAFE_URL"

          # Quick reachability check: 404=bad owner/repo, 401=bad token
          if ! git ls-remote "$MIRROR_URL" >/dev/null 2>&1; then
            echo "Cannot reach $SAFE_URL. Check owner/repo spelling, token scopes, and that the repo exists."
            exit 1
          fi

          git remote remove mirror 2>/dev/null || true
          git remote add mirror "$MIRROR_URL"
          git push mirror --all
          git push mirror --tags
